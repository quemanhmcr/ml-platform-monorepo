# =============================================================================
# Workflow: Terraform Apply - Infrastructure Deployment
#
# Purpose
# - Validate Terraform code
# - Plan infrastructure changes
# - Apply infrastructure changes to AWS
# - Deploy infrastructure (EKS, VPC, ArgoCD, etc.)
#
# Flow
# 1. Checkout code
# 2. Configure AWS credentials (OIDC)
# 3. Setup Terraform
# 4. Terraform Init
# 5. Terraform Validate
# 6. Terraform Format Check
# 7. Terraform Plan (preview changes)
# 8. Terraform Apply (deploy infrastructure)
# =============================================================================
name: Terraform Apply and Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production
      terraform_action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: 'plan'
      auto_approve:
        description: 'Auto approve terraform apply (use with caution)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
      - develop
    paths:
      - '*.tf'
      - 'modules/**'
      - 'terraform.tfvars'
      - '.github/workflows/terraform-apply.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '*.tf'
      - 'modules/**'

permissions:
  id-token: write  # Required for OIDC authentication with AWS
  contents: write  # Required for checkout and push code
  pull-requests: write  # Required for PR comments

env:
  TF_VERSION: "1.5.0"
  AWS_REGION: "ap-southeast-2"

jobs:
  terraform-plan:
    name: Terraform Plan and Apply
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'))
    permissions:
      id-token: write
      contents: write
      pull-requests: write
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
      url: https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::465002806239:role/github-role-infra-live
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Format (auto-fix)
        shell: bash
        run: |
          set -euo pipefail
          terraform fmt -recursive
          if [[ -n $(git status -s) ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add -A
            git commit -m "style(terraform): auto-format via terraform fmt"
            BRANCH="${{ github.head_ref != '' && github.head_ref || github.ref_name }}"
            git push origin HEAD:"${BRANCH}" || true
          fi

      - name: Terraform Init
        shell: bash
        env:
          TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}
          TF_BACKEND_KEY: ${{ secrets.TF_BACKEND_KEY }}
          TF_BACKEND_REGION: ${{ secrets.TF_BACKEND_REGION }}
        run: |
          set -euo pipefail
          if [[ -n "${TF_BACKEND_BUCKET:-}" && -n "${TF_BACKEND_KEY:-}" && -n "${TF_BACKEND_REGION:-}" ]]; then
            terraform init \
              -backend-config="bucket=${TF_BACKEND_BUCKET}" \
              -backend-config="key=${TF_BACKEND_KEY}" \
              -backend-config="region=${TF_BACKEND_REGION}" \
              -input=false \
              -reconfigure
          else
            echo "No S3 backend secrets provided; using local backend"
            terraform init -backend=false -input=false -reconfigure
          fi

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: false

      - name: Determine environment
        id: env
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="production"
          else
            ENV="staging"
          fi
          echo "environment=${ENV}" >> $GITHUB_OUTPUT

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -out=tfplan \
            -no-color \
            -input=false | tee plan_output.txt
        continue-on-error: false

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let planOutput = 'Plan output not available';
            try {
              planOutput = fs.readFileSync('plan_output.txt', 'utf8');
            } catch (error) {
              planOutput = 'Unable to read plan output';
            }
            
            const output = `#### Terraform Plan for \`${{ steps.env.outputs.environment }}\` environment
            \`\`\`
            ${planOutput}
            \`\`\`
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Upload Terraform Plan
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ steps.env.outputs.environment }}
          path: tfplan
          retention-days: 5

      # Conditional Apply in the same job
      - name: Terraform Apply
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.terraform_action == 'apply') ||
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'))
        id: apply
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.auto_approve }}" == "true" ]] || [[ "${{ github.event_name }}" == "push" ]]; then
            terraform apply -auto-approve -no-color tfplan
          else
            terraform apply -no-color tfplan
          fi

      - name: Get Terraform Outputs
        id: outputs
        if: steps.apply.outcome == 'success'
        run: |
          echo "cluster_endpoint=$(terraform output -raw eks_cluster_endpoint 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
          echo "cluster_name=$(terraform output -raw eks_cluster_name 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
          echo "vpc_id=$(terraform output -raw vpc_id 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        if: steps.apply.outcome == 'success'
        run: |
          echo "## ðŸš€ Infrastructure Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Name:** ${{ steps.outputs.outputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Endpoint:** ${{ steps.outputs.outputs.cluster_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "**VPC ID:** ${{ steps.outputs.outputs.vpc_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure kubectl: \`aws eks update-kubeconfig --name ${{ steps.outputs.outputs.cluster_name }} --region ${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify nodes: \`kubectl get nodes\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check ArgoCD: \`kubectl get pods -n argocd\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push (if changes)
        if: steps.apply.outcome == 'success' && github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if [[ -n $(git status -s) ]]; then
            git add -A
            git commit -m "chore: update infrastructure state after terraform apply [skip ci]" || exit 0
            git push origin HEAD:${{ github.ref }} || exit 0
          fi

  

