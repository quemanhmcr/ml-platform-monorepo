name: build-and-release

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'components/inference/**'
      - '.github/workflows/build-and-release.yml'

permissions:
  id-token: write
  contents: read

env:
  IMAGE_NAME: ml-fashion-recommender/inference

jobs:
  build-push-and-update-gitops:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Derive environment
        id: env
        shell: bash
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then ENV=production; TAG_PREFIX=main; else ENV=staging; TAG_PREFIX=develop; fi
          echo "env=${ENV}" >> $GITHUB_OUTPUT
          echo "tag_prefix=${TAG_PREFIX}" >> $GITHUB_OUTPUT
          echo "sha7=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Load AWS configuration (Secrets-only, Zero-Trust)
        id: aws-config-loader
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_IAM_ROLE_ARN: ${{ secrets.AWS_IAM_ROLE_ARN }}
          AWS_ECR_REGISTRY: ${{ secrets.AWS_ECR_REGISTRY }}
        run: |
          set -Eeuo pipefail
          # Validate required secrets
          : "${AWS_ACCOUNT_ID:?Missing AWS_ACCOUNT_ID}"
          : "${AWS_REGION:?Missing AWS_REGION}"
          : "${AWS_IAM_ROLE_ARN:?Missing AWS_IAM_ROLE_ARN}"

          # Prefer explicit registry secret if provided, else derive from account/region
          if [[ -n "${AWS_ECR_REGISTRY:-}" && "${AWS_ECR_REGISTRY}" != "null" ]]; then
            ECR_REGISTRY="${AWS_ECR_REGISTRY}"
          else
            ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          fi

          echo "account_id=${AWS_ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "region=${AWS_REGION}" >> $GITHUB_OUTPUT
          echo "iam_role_arn=${AWS_IAM_ROLE_ARN}" >> $GITHUB_OUTPUT
          echo "ecr_registry=${ECR_REGISTRY}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials (OIDC AssumeRole)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws-config-loader.outputs.iam_role_arn }}
          aws-region: ${{ steps.aws-config-loader.outputs.region }}
          role-session-name: GitHubActions-${{ github.run_id }}-${{ github.run_attempt }}
          retry-max-attempts: 0
          disable-retry: true

      - name: Verify caller identity
        run: aws sts get-caller-identity

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push inference image
        id: docker
        env:
          ECR_REGISTRY: ${{ steps.aws-config-loader.outputs.ecr_registry }}
          REGION: ${{ steps.aws-config-loader.outputs.region }}
          TAG_PREFIX: ${{ steps.env.outputs.tag_prefix }}
          SHA7: ${{ steps.env.outputs.sha7 }}
        run: |
          set -Eeuo pipefail
          REPO_URI="${ECR_REGISTRY}/${IMAGE_NAME}"
          TAG_SHA="${TAG_PREFIX}-${SHA7}"
          TAG_LATEST="${TAG_PREFIX}-latest"
          echo "repo_uri=${REPO_URI}" >> $GITHUB_OUTPUT
          echo "tag_sha=${TAG_SHA}" >> $GITHUB_OUTPUT
          echo "tag_latest=${TAG_LATEST}" >> $GITHUB_OUTPUT

          docker build -t "${REPO_URI}:${TAG_SHA}" -t "${REPO_URI}:${TAG_LATEST}" ./components/inference
          docker push "${REPO_URI}:${TAG_SHA}"
          docker push "${REPO_URI}:${TAG_LATEST}"

      - name: Resolve GitOps secrets
        id: gitops
        env:
          GITOPS_TOKEN: ${{ secrets.GITOPS_TOKEN }}
          GITOPS_REPO: ${{ secrets.GITOPS_REPO }}
        run: |
          set -Eeuo pipefail
          if [[ -n "${GITOPS_REPO}" && -n "${GITOPS_TOKEN}" ]]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Update GitOps repo image tag
        env:
          GITOPS_TOKEN: ${{ secrets.GITOPS_TOKEN }}
          GITOPS_REPO: ${{ secrets.GITOPS_REPO }}
        if: ${{ steps.gitops.outputs.enabled == 'true' }}
        run: |
          set -Eeuo pipefail
          ENV="${{ steps.env.outputs.env }}"
          REPO_URI="${{ steps.docker.outputs.repo_uri }}"
          TAG_SHA="${{ steps.docker.outputs.tag_sha }}"
          WORKDIR=$(mktemp -d)
          git config --global user.name "gh-actions-bot"
          git config --global user.email "gh-actions-bot@users.noreply.github.com"
          git clone "https://${GITOPS_TOKEN}@${GITOPS_REPO#https://}" "$WORKDIR/gitops"
          pushd "$WORKDIR/gitops/apps/ml-recommendation-inference/overlays/${ENV}"
          # Cập nhật newName và newTag bằng yq nếu có, fallback sed
          if command -v yq >/dev/null 2>&1; then
            yq -i 
              '.images[] |= (select(.name=="inference").newName = "'"${REPO_URI}"'")' kustomization.yaml || true
            yq -i 
              '.images[] |= (select(.name=="inference").newTag = "'"${TAG_SHA}"'")' kustomization.yaml
          else
            # sed fallback: thay newTag và newName theo dòng hiện hữu
            sed -i "s#^\s*newName: .*#    newName: ${REPO_URI}#" kustomization.yaml
            sed -i "s#^\s*newTag: .*#    newTag: ${TAG_SHA}#" kustomization.yaml
          fi
          git add kustomization.yaml
          git commit -m "ci: update inference image to ${TAG_SHA} (${ENV})"
          git push origin HEAD
          popd


